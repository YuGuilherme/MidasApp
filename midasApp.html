<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midas - Web App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div id="root"></div>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <script type="text/babel">
      // Firebase configuration from environment variables
      const firebaseConfig = typeof __firebase_config !== 'undefined' && Object.keys(JSON.parse(__firebase_config)).length > 0
        ? JSON.parse(__firebase_config)
        : {
            apiKey: "dummy-api-key",
            authDomain: "dummy-auth-domain",
            projectId: "midas-dummy-project-id",
            storageBucket: "dummy-storage-bucket",
            messagingSenderId: "dummy-messaging-sender-id",
            appId: "dummy-app-id"
        };
      
      const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // Initialize Firebase
      let app, db, auth;
      try {
        app = firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        auth = firebase.auth();
      } catch (e) {
        console.error("Firebase initialization error:", e);
      }

      // Helper functions for audio playback
      const base64ToArrayBuffer = (base64) => {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
      };

      const pcmToWav = (pcm16, sampleRate) => {
        const dataLength = pcm16.length * 2;
        const buffer = new ArrayBuffer(44 + dataLength);
        const view = new DataView(buffer);

        // Write WAV file header
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataLength, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, 1, true); // Mono
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * 2, true);
        view.setUint16(32, 2, true);
        view.setUint16(34, 16, true);
        writeString(view, 36, 'data');
        view.setUint32(40, dataLength, true);

        // Write PCM data
        let offset = 44;
        for (let i = 0; i < pcm16.length; i++) {
            view.setInt16(offset, pcm16[i], true);
            offset += 2;
        }

        return new Blob([view], { type: 'audio/wav' });
      };
      
      const writeString = (view, offset, string) => {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
      };
      
      const App = () => {
        const [transactions, setTransactions] = React.useState([]);
        const [description, setDescription] = React.useState('');
        const [amount, setAmount] = React.useState('');
        const [type, setType] = React.useState('expense');
        const [userId, setUserId] = React.useState(null);
        const [authReady, setAuthReady] = React.useState(false);
        const [editingId, setEditingId] = React.useState(null);
        const [filter, setFilter] = React.useState('all');
        const [message, setMessage] = React.useState('');
        const [searchDescription, setSearchDescription] = React.useState('');
        const [searchDate, setSearchDate] = React.useState('');
        const [financialAnalysis, setFinancialAnalysis] = React.useState('');
        const [isLoadingAnalysis, setIsLoadingAnalysis] = React.useState(false);
        const [isLoadingCategory, setIsLoadingCategory] = React.useState(false);
        const [activeTab, setActiveTab] = React.useState('main'); // 'main', 'history', 'charts', 'goals'

        // Chart specific filters
        const [chartDate, setChartDate] = React.useState('');
        const [chartCategoryFilter, setChartCategoryFilter] = React.useState('all');

        // New states for Goals and TTS
        const [goal, setGoal] = React.useState('');
        const [goalAmount, setGoalAmount] = React.useState('');
        const [goalAnalysis, setGoalAnalysis] = React.useState('');
        const [isLoadingGoal, setIsLoadingGoal] = React.useState(false);
        const [isSpeaking, setIsSpeaking] = React.useState(false);
        const [audioContext, setAudioContext] = React.useState(null);
        const [audioSource, setAudioSource] = React.useState(null);

        // Set up Firebase authentication and listener
        React.useEffect(() => {
          const authSetup = async () => {
            try {
              if (initialAuthToken) {
                await auth.signInWithCustomToken(initialAuthToken);
              } else {
                await auth.signInAnonymously();
              }
            } catch (error) {
              console.error("Authentication error:", error);
            }
          };
          
          authSetup();

          const unsubscribe = auth.onAuthStateChanged((user) => {
            if (user) {
              setUserId(user.uid);
            }
            setAuthReady(true);
          });

          return () => unsubscribe();
        }, []);

        // Set up Firestore listener for transactions
        React.useEffect(() => {
          if (!authReady || !userId) return;
          
          const q = db.collection(`artifacts/${appId}/users/${userId}/transactions`);

          const unsubscribe = q.onSnapshot((querySnapshot) => {
            const docs = querySnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data(),
            })).sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); // Client-side sorting
            setTransactions(docs);
          });

          return () => unsubscribe();
        }, [userId, authReady]);

        // Show a temporary message
        const showMessage = (text) => {
          setMessage(text);
          setTimeout(() => setMessage(''), 3000);
        };

        // Handle adding or updating a transaction
        const handleSaveTransaction = async () => {
          if (!description || !amount || !userId) {
            showMessage('Por favor, preencha todos os campos.');
            return;
          }
          const amountValue = parseFloat(amount);
          if (isNaN(amountValue)) {
            showMessage('O valor deve ser um número válido.');
            return;
          }

          try {
            const transactionData = {
              description: description,
              amount: type === 'expense' ? -amountValue : amountValue,
              type: type,
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };

            if (editingId) {
              await db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc(editingId).update(transactionData);
              showMessage('Transação atualizada com sucesso!');
            } else {
              await db.collection(`artifacts/${appId}/users/${userId}/transactions`).add(transactionData);
              showMessage('Transação adicionada com sucesso!');
            }

            // Reset form
            setEditingId(null);
            setDescription('');
            setAmount('');
            setType('expense');
          } catch (e) {
            console.error("Erro ao salvar documento: ", e);
            showMessage('Erro ao salvar a transação. Tente novamente.');
          }
        };

        // Handle delete transaction
        const handleDeleteTransaction = async (id) => {
          try {
            await db.collection(`artifacts/${appId}/users/${userId}/transactions`).doc(id).delete();
            showMessage('Transação excluída com sucesso!');
          } catch (e) {
            console.error("Erro ao excluir documento: ", e);
            showMessage('Erro ao excluir a transação. Tente novamente.');
          }
        };

        // Handle edit transaction
        const handleEditTransaction = (transaction) => {
          setEditingId(transaction.id);
          setDescription(transaction.description);
          setAmount(Math.abs(transaction.amount));
          setType(transaction.amount >= 0 ? 'revenue' : 'expense');
          setActiveTab('main'); // Switch to main tab for editing
        };

        // LLM API call to get financial analysis
        const handleGetFinancialAnalysis = async () => {
          setIsLoadingAnalysis(true);
          try {
            const transactionsText = transactions
              .map(t => `${t.description}: R$${t.amount.toFixed(2)} (${t.type})`)
              .join('\n');
            
            const prompt = `Analise as seguintes transações financeiras e forneça um resumo dos hábitos de consumo, os principais gastos e, se possível, uma dica para economizar. Responda em português. Aqui estão as transações:\n\n${transactionsText}`;
            
            const payload = {
              contents: [{ parts: [{ text: prompt }] }],
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const result = await response.json();
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
              setFinancialAnalysis(text);
            } else {
              setFinancialAnalysis('Não foi possível gerar a análise. Tente novamente mais tarde.');
            }
          } catch (error) {
            console.error("Error fetching financial analysis:", error);
            setFinancialAnalysis('Erro ao obter a análise. Verifique sua conexão.');
          } finally {
            setIsLoadingAnalysis(false);
          }
        };

        // LLM API call to suggest a category
        const handleSuggestCategory = async () => {
          if (!description) {
            showMessage('Por favor, digite uma descrição para sugerir a categoria.');
            return;
          }
          setIsLoadingCategory(true);
          try {
            const prompt = `Sugira uma única categoria curta e concisa (por exemplo: "Alimentação", "Transporte", "Moradia", "Lazer", "Contas") para a seguinte transação: "${description}". Responda apenas com o nome da categoria.`;
            
            const payload = {
              contents: [{ parts: [{ text: prompt }] }],
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const result = await response.json();
            const suggestedCategory = result?.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

            if (suggestedCategory) {
              setDescription(prevDesc => `${prevDesc} (${suggestedCategory})`);
              showMessage('Categoria sugerida e adicionada!');
            } else {
              showMessage('Não foi possível sugerir uma categoria.');
            }
          } catch (error) {
            console.error("Error fetching category suggestion:", error);
            showMessage('Erro ao sugerir categoria. Tente novamente.');
          } finally {
            setIsLoadingCategory(false);
          }
        };

        // LLM API call to generate a goal plan
        const handleGenerateGoalPlan = async () => {
            if (!goal || !goalAmount) {
                showMessage('Por favor, preencha a meta e o valor.');
                return;
            }
            setIsLoadingGoal(true);
            try {
                const prompt = `Crie um plano de economia detalhado e motivacional para a seguinte meta: "${goal}" com o valor de R$${goalAmount}. Considere a média de gastos (pode usar os dados de transações do usuário) e sugira dicas práticas para economizar. Responda em português e de forma amigável.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const planText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (planText) {
                    setGoalAnalysis(planText);
                } else {
                    setGoalAnalysis('Não foi possível gerar um plano de economia.');
                }
            } catch (error) {
                console.error("Error fetching goal analysis:", error);
                setGoalAnalysis('Erro ao gerar o plano. Tente novamente.');
            } finally {
                setIsLoadingGoal(false);
            }
        };
        // TTS API call to speak the financial analysis
        const handleSpeakAnalysis = async () => {
          if (isSpeaking) {
            audioSource?.stop();
            setIsSpeaking(false);
            return;
          }

          if (!financialAnalysis) {
            showMessage('Gere a análise financeira primeiro.');
            return;
          }
          
          setIsSpeaking(true);
          try {
            const payload = {
              contents: [{ parts: [{ text: financialAnalysis }] }],
              generationConfig: {
                  responseModalities: ["AUDIO"],
                  speechConfig: {
                      voiceConfig: {
                          prebuiltVoiceConfig: { voiceName: "Iapetus" }
                      }
                  }
              },
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/")) {
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audio = new Audio(audioUrl);
                audio.onended = () => {
                  setIsSpeaking(false);
                };
                audio.play();

            } else {
                showMessage('Não foi possível gerar áudio. Tente novamente.');
                setIsSpeaking(false);
            }

          } catch (error) {
            console.error("Error fetching TTS:", error);
            showMessage('Erro ao gerar o áudio. Tente novamente.');
            setIsSpeaking(false);
          }
        };


        // Filter transactions for history tab
        const historyFilteredTransactions = transactions.filter(t => {
          if (filter !== 'all' && t.type !== filter) {
            return false;
          }
          if (searchDescription && !t.description.toLowerCase().includes(searchDescription.toLowerCase())) {
            return false;
          }
          if (searchDate) {
            const transactionDate = t.timestamp ? new Date(t.timestamp.seconds * 1000).toISOString().split('T')[0] : '';
            if (transactionDate !== searchDate) {
              return false;
            }
          }
          return true;
        });

        // Filter transactions for charts tab
        const chartFilteredTransactions = React.useMemo(() => {
          return transactions.filter(t => {
            // Filter by category
            if (chartCategoryFilter !== 'all') {
              const matches = t.description.match(/\((.*?)\)/);
              const category = matches ? matches[1].trim().toLowerCase() : '';
              if (category !== chartCategoryFilter.toLowerCase()) {
                return false;
              }
            }
            // Filter by date
            if (chartDate) {
              const transactionDate = t.timestamp ? new Date(t.timestamp.seconds * 1000).toISOString().split('T')[0] : '';
              if (transactionDate !== chartDate) {
                return false;
              }
            }
            return true;
          });
        }, [transactions, chartCategoryFilter, chartDate]);


        // Extract unique categories for chart filter buttons
        const uniqueCategories = React.useMemo(() => {
          const categories = new Set();
          transactions.forEach(t => {
            const matches = t.description.match(/\((.*?)\)/);
            if (matches && matches[1]) {
              categories.add(matches[1].trim());
            }
          });
          return ['all', ...Array.from(categories)];
        }, [transactions]);


        // Calculate daily balance for chart and sort by date
        const chartData = React.useMemo(() => {
          const dailyBalanceMap = chartFilteredTransactions.reduce((acc, t) => {
            const date = t.timestamp ? new Date(t.timestamp.seconds * 1000).toISOString().split('T')[0] : 'N/A';
            acc[date] = (acc[date] || 0) + t.amount;
            return acc;
          }, {});
        
          const sortedDates = Object.keys(dailyBalanceMap).sort((a, b) => new Date(a) - new Date(b));
        
          const cumulativeBalance = {};
          let runningTotal = 0;
          for (const date of sortedDates) {
            runningTotal += dailyBalanceMap[date];
            cumulativeBalance[date] = runningTotal;
          }
        
          return sortedDates.map(date => ({
            date: new Date(date).toLocaleDateString(),
            amount: cumulativeBalance[date]
          }));
        }, [chartFilteredTransactions]);

        const totalBalance = transactions.reduce((acc, current) => acc + current.amount, 0);

        return (
          <div className="flex flex-col md:flex-row min-h-screen bg-gray-100 p-8">
            {message && (
              <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-lg shadow-md z-50 transition-all duration-300 transform translate-y-0">
                {message}
              </div>
            )}
            
            {/* Lado Esquerdo - Dashboard e Anúncios */}
            <div className="flex-1 max-w-lg mx-auto md:mr-4 mb-8 md:mb-0 space-y-6">
                <div className="w-full bg-white rounded-xl shadow-lg p-6 space-y-6">
                    <h1 className="text-3xl font-bold text-center text-gray-800">Midas - Controle Financeiro</h1>
                    
                    {/* Bloco do Saldo */}
                    <div className="w-full bg-gray-200 p-4 rounded-xl text-center">
                        <p className="text-xl font-semibold text-gray-700">Saldo Total:</p>
                        <p className={`text-4xl font-bold ${totalBalance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            R$ {totalBalance.toFixed(2)}
                        </p>
                    </div>

                    {/* Formulário de Transação */}
                    <div className="space-y-4 pt-6">
                        <h2 className="text-2xl font-bold text-gray-800">{editingId ? 'Editar Transação' : 'Adicionar Nova Transação'}</h2>
                        <div className="flex flex-wrap items-center gap-2">
                            <input
                                type="text"
                                placeholder="Descrição"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                className="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]"
                            />
                            <button
                                onClick={handleSuggestCategory}
                                disabled={isLoadingCategory}
                                className={`p-3 rounded-lg font-semibold transition-colors text-sm flex-shrink-0 whitespace-nowrap ${isLoadingCategory ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-purple-500 text-white hover:bg-purple-600'}`}
                            >
                                {isLoadingCategory ? '...' : '✨ Sugerir Categoria ✨'}
                            </button>
                        </div>
                        <input
                            type="number"
                            placeholder="Valor"
                            value={amount}
                            onChange={(e) => setAmount(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                        <div className="flex justify-around space-x-2">
                            <button
                                onClick={() => setType('expense')}
                                className={`flex-1 p-3 rounded-lg font-semibold transition-colors ${type === 'expense' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}
                            >
                                Despesa
                            </button>
                            <button
                                onClick={() => setType('revenue')}
                                className={`flex-1 p-3 rounded-lg font-semibold transition-colors ${type === 'revenue' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                            >
                                Receita
                            </button>
                        </div>
                        <button
                            onClick={handleSaveTransaction}
                            className="w-full p-3 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition-colors"
                        >
                            {editingId ? 'Salvar Transação' : 'Adicionar Transação'}
                        </button>
                    </div>

                    {/* Histórico e Anúncios */}
                    <div className="space-y-2 pt-4">
                        <h2 className="text-xl font-bold text-gray-800">Filtros do Histórico</h2>
                        <div className="flex flex-wrap gap-2">
                            <button
                                onClick={() => setFilter('all')}
                                className={`flex-1 min-w-[80px] p-2 rounded-lg font-semibold text-sm transition-colors ${filter === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                            >
                                Todas
                            </button>
                            <button
                                onClick={() => setFilter('revenue')}
                                className={`flex-1 min-w-[80px] p-2 rounded-lg font-semibold text-sm transition-colors ${filter === 'revenue' ? 'bg-green-500 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                            >
                                Receitas
                            </button>
                            <button
                                onClick={() => setFilter('expense')}
                                className={`flex-1 min-w-[80px] p-2 rounded-lg font-semibold text-sm transition-colors ${filter === 'expense' ? 'bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}`}
                            >
                                Despesas
                            </button>
                        </div>
                        <div className="flex flex-wrap gap-2">
                            <input
                                type="text"
                                placeholder="Filtrar por descrição..."
                                value={searchDescription}
                                onChange={(e) => setSearchDescription(e.target.value)}
                                className="flex-1 p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]"
                            />
                            <input
                                type="date"
                                value={searchDate}
                                onChange={(e) => setSearchDate(e.target.value)}
                                className="flex-1 p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[150px]"
                            />
                        </div>
                    </div>

                    <div className="space-y-4">
                        <h2 className="text-2xl font-bold text-gray-800">Histórico de Transações</h2>
                        {historyFilteredTransactions.length > 0 ? (
                            <ul className="space-y-3 max-h-[400px] overflow-y-auto">
                                {historyFilteredTransactions.map((t) => (
                                    <li key={t.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-lg shadow-sm">
                                        <div className="flex-1">
                                            <p className="text-lg font-medium text-gray-900">{t.description}</p>
                                            <p className="text-sm text-gray-500">
                                                {t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleDateString() : 'Carregando...'}
                                            </p>
                                        </div>
                                        <div className="flex items-center space-x-2">
                                            <span className={`text-lg font-bold ${t.amount >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                R$ {t.amount.toFixed(2)}
                                            </span>
                                            <button onClick={() => handleEditTransaction(t)} className="text-blue-500 hover:text-blue-700">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM7 14.172V17h2.828l7.586-7.586-2.828-2.828-7.586 7.586zM4 5a1 1 0 011-1h1a1 1 0 110 2H5v10h10v-1a1 1 0 112 0v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5z" clipRule="evenodd" />
                                                </svg>
                                            </button>
                                            <button onClick={() => handleDeleteTransaction(t.id)} className="text-red-500 hover:text-red-700">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" />
                                                </svg>
                                            </button>
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-center text-gray-500">Nenhuma transação adicionada ainda.</p>
                        )}
                    </div>

                    {/* Espaço para Anúncio */}
                    <div className="bg-gray-200 p-4 rounded-lg text-center border border-dashed border-gray-400 mt-6">
                        <p className="text-gray-500">Espaço para Anúncio</p>
                        <p className="text-sm text-gray-400">(Banner 300x250)</p>
                    </div>
                </div>
            </div>

            {/* Lado Direito - Análise e Anúncios */}
            <div className="flex-1 max-w-lg mx-auto md:ml-4 space-y-6">
                <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">Filtros do Gráfico</h2>
                    <div className="flex flex-col md:flex-row gap-2">
                        <div className="flex-1 flex flex-wrap gap-2">
                            {uniqueCategories.map(cat => (
                                <button
                                    key={cat}
                                    onClick={() => setChartCategoryFilter(cat)}
                                    className={`p-2 rounded-lg font-semibold text-xs transition-colors ${chartCategoryFilter === cat ? 'bg-blue-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                >
                                    {cat === 'all' ? 'Todas' : cat}
                                </button>
                            ))}
                        </div>
                        <input
                            type="date"
                            value={chartDate}
                            onChange={(e) => setChartDate(e.target.value)}
                            className="flex-1 p-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <div className="space-y-4">
                        <h2 className="text-2xl font-bold text-gray-800">Gráfico de Saldo Diário</h2>
                        <div className="h-40 bg-gray-50 rounded-lg p-2 flex items-end justify-around relative">
                            {chartData.length > 0 ? chartData.map((data, index) => {
                                const allAmounts = Object.values(chartData).map(item => Math.abs(item.amount));
                                const maxAmount = Math.max(...allAmounts, 1);
                                const height = (Math.abs(data.amount) / maxAmount) * 100;
                                const isPositive = data.amount >= 0;
                                return (
                                    <div key={index} className="flex flex-col items-center">
                                        <div
                                            className={`w-4 rounded-t-lg transition-all duration-500 ${isPositive ? 'bg-green-400' : 'bg-red-400'}`}
                                            style={{ height: `${height * 0.8}%` }}
                                        ></div>
                                        <span className="text-xs text-gray-500 mt-1">{data.date.substring(0, 5)}</span>
                                    </div>
                                );
                            }) : (
                                <p className="text-center text-gray-500 absolute inset-0 flex items-center justify-center">Nenhum dado para o gráfico.</p>
                            )}
                        </div>
                    </div>
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                    <button
                        onClick={handleGetFinancialAnalysis}
                        disabled={isLoadingAnalysis}
                        className={`w-full p-3 rounded-lg font-bold transition-colors ${isLoadingAnalysis ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'}`}
                    >
                        {isLoadingAnalysis ? 'Gerando Análise...' : '✨ Obter Análise Financeira ✨'}
                    </button>
                    {financialAnalysis && (
                        <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                            <h3 className="text-xl font-semibold text-gray-800 mb-2">Análise Financeira</h3>
                            <p className="text-gray-700 whitespace-pre-wrap">{financialAnalysis}</p>
                            <button
                              onClick={handleSpeakAnalysis}
                              disabled={isSpeaking}
                              className={`mt-2 w-full p-2 rounded-lg font-bold transition-colors ${isSpeaking ? 'bg-blue-400 text-white cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}`}
                            >
                              {isSpeaking ? 'Parar Áudio' : '✨ Ouvir Análise ✨'}
                            </button>
                        </div>
                    )}
                </div>

                <div className="bg-white rounded-xl shadow-lg p-6 space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800">Planejador de Metas ✨</h2>
                    <input
                        type="text"
                        placeholder="Ex: Economizar para viajar"
                        value={goal}
                        onChange={(e) => setGoal(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <input
                        type="number"
                        placeholder="Valor da meta (R$)"
                        value={goalAmount}
                        onChange={(e) => setGoalAmount(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <button
                        onClick={handleGenerateGoalPlan}
                        disabled={isLoadingGoal}
                        className={`w-full p-3 rounded-lg font-bold transition-colors ${isLoadingGoal ? 'bg-gray-400 text-gray-600 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'}`}
                    >
                        {isLoadingGoal ? 'Gerando Plano...' : '✨ Gerar Plano de Economia ✨'}
                    </button>
                    {goalAnalysis && (
                        <div className="bg-gray-50 p-4 rounded-lg shadow-sm">
                            <h3 className="text-xl font-semibold text-gray-800 mb-2">Seu Plano de Economia</h3>
                            <p className="text-gray-700 whitespace-pre-wrap">{goalAnalysis}</p>
                        </div>
                    )}
                </div>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
